<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Send From Duck | API Key Check</title>
    <link rel="stylesheet" href="./styles/auth_style.css" />
    <title>Authorization</title>
  </head>
  <body>
    <div class="container">
      <h1>API Key Check</h1>
      <p id="message"></p>
      <div id="buttons"></div>
    </div>
    <script>
      let validateResult;
      // Check if the user has dark mode enabled
      if (
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches
      ) {
        // Add the dark-mode class to the body element
        const elements = document.querySelectorAll("*");
        elements.forEach(function (element) {
          element.classList.toggle("dark-mode");
        });
      }
      // get key value from URL
      const urlParams = new URLSearchParams(window.location.search);
      const key = urlParams.get("key");

      // get apiKey value from localStorage
      const apiKey = localStorage.getItem("apiKey");
      // check if apiKey is the same as key
      if (apiKey === key) {
        // redirect back to index.html
        window.location.href = "./";
      } else if (!key) {
        const messageElement = document.getElementById("message");
        messageElement.textContent = "No API key given";
      } else if (apiKey) {
        // add buttons for overwriting apiKey
        const messageElement = document.getElementById("message");
        messageElement.textContent =
          "Do you want to overwrite your previous API key?";
        const buttonsElement = document.getElementById("buttons");
        const yesButton = document.createElement("button");
        yesButton.style.backgroundColor = "green";
        yesButton.style.marginRight = "10px";
        yesButton.textContent = "Yes";
        yesButton.addEventListener("click", function () {
          // Remove buttons
          buttonsElement.remove();

          // Show loading message
          messageElement.textContent = "Loading...";

          async function validateAndRedirect1() {
            validateResult = await checkEmailAddresses(key);
            if (validateResult === null) {
              messageElement.textContent = "Invalid API key Given";

              // Add "Go back" button
              const goBackButton = document.createElement("button");
              goBackButton.textContent = "Go back";
              goBackButton.addEventListener("click", function () {
                // redirect back to index.html
                window.location.href = "./";
              });

              // Create a div to hold the button
              const buttonDiv = document.createElement("div");
              buttonDiv.style.display = "flex";
              buttonDiv.style.justifyContent = "center";
              buttonDiv.style.marginTop = "20px";

              // Append the button to the div
              buttonDiv.appendChild(goBackButton);

              // Append the div to the body
              document.body.appendChild(buttonDiv);
            } else {
              // If validation is successful, overwrite apiKey and redirect
              localStorage.setItem("loginAddress", validateResult.address);
              localStorage.setItem("loginAddressKey", key);
              localStorage.setItem("apiKey", key);
              window.location.href = "./";
            }
          }
          validateAndRedirect1();
        });
        const noButton = document.createElement("button");
        noButton.style.backgroundColor = "red";
        noButton.style.marginLeft = "10px";
        noButton.textContent = "No";
        noButton.addEventListener("click", function () {
          // redirect back to index.html
          window.location.href = "./";
        });
        buttonsElement.appendChild(yesButton);
        buttonsElement.appendChild(noButton);
      } else {
        async function validateAndRedirect2() {
          validateResult = await checkEmailAddresses(key);
          if (validateResult === null) {
            const messageElement = document.getElementById("message");
            messageElement.textContent = "Invalid API key Given";

            // Add "Go back" button
            const goBackButton = document.createElement("button");
            goBackButton.textContent = "Go back";
            goBackButton.addEventListener("click", function () {
              // redirect back to index.html
              window.location.href = "./";
            });

            // Create a div to hold the button
            const buttonDiv = document.createElement("div");
            buttonDiv.style.display = "flex";
            buttonDiv.style.justifyContent = "center";
            buttonDiv.style.marginTop = "20px";

            // Append the button to the div
            buttonDiv.appendChild(goBackButton);

            // Append the div to the body
            document.body.appendChild(buttonDiv);
          } else {
            // If validation is successful, write apiKey and redirect
            localStorage.setItem("loginAddress", validateResult.address);
            localStorage.setItem("loginAddressKey", key);
            localStorage.setItem("apiKey", key);
            window.location.href = "./";
          }
        }
      }
      async function checkEmailAddresses(apiKey) {
        const url =
          "https://corsproxy.io/?https://quack.duckduckgo.com/api/email/addresses";
        const requestInit = {
          method: "POST",
          headers: {
            Authorization: `Bearer ${apiKey}`,
            "Content-Type": "application/json",
            "x-cors-api-key": "KEY_HERE",
          },
        };
        const response = await fetch(url, requestInit);
        if (response.status === 401) {
          return null;
        } else {
          const json = await response.json();
          return json;
        }
      }
    </script>
  </body>
</html>
