<!DOCTYPE html>
<html>
    <head>
        <title>Duck Address Send Generator</title>
        <link rel="icon" href="favicon.ico" type="image/x-icon">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="./styles/style.css">
    </head>
    <body>
        <div class="container">
            <h1>Duck Address Sending Generator ðŸ¦†</h1>
            <h3>Did you know that you can send FROM duck addresses? All you have to do is put in the info and then send the email from your own email address to the special created one!</h3>

            <div style="display: flex; flex-direction: column;">
                <label for="textbox1">Address to send TO:</label>
                <input type="email" id="textbox1" name="textbox1" placeholder="john@example.com" autocomplete="off">
                <label for="textbox2">Address to send FROM:</label>
                <div style="display: flex; flex-direction: row; align-items: center;">
                    <div style="display: flex; flex-direction: row; align-items: center; flex: 1; justify-content: flex-end;">
                        <input type="email" id="textbox2" name="textbox2" placeholder="tim@duck.com" style="flex-grow: 1;">
                        <button onclick="openPopup()" style="margin-left: 10px; padding: 5px 10px;">ðŸ”ƒ</button>
                    </div>
                    
                    <div id="popup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 999;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #fff; padding: 20px; border-radius: 5px;">
                            <h2>DDG API Key:</h2>
                            <input type="password" id="popupInput">
                            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                                <button onclick="closePopup()">OK</button>
                                <button onclick="document.getElementById('popup').style.display = 'none';">Cancel</button>
                            </div>
                        </div>
                    </div>

                    </div>                
                <button onclick="combineText()">Create Address!</button>
                

            <div style="display: flex; flex-direction: column; align-items: center;" hidden>
                <p id="combinedText" style="font-size: 24px; font-weight: bold; color: #333; margin-top: 20px; text-align: center;"></p>
                
            </div>
            <div style="display: flex; justify-content: center;">
                <button id="copyButton" onclick="copyToClipboard()" style="margin-top: 20px; background-color: #007bff; color: #fff; border: none; border-radius: 5px; padding: 10px 20px; cursor: pointer; text-align: center;" hidden>Copy to Clipboard</button>
                <button id="mailButton" onclick="sendEmail()" style="margin-top: 20px; margin-left: 10px; background-color: #007bff; color: #fff; border: none; border-radius: 5px; padding: 10px 20px; cursor: pointer; text-align: center;" hidden>Open in Mail</button>
            </div>
        </div>
        <script>
            function combineText() {
                var textbox1Value = document.getElementById("textbox1").value;
                var textbox2Value = document.getElementById("textbox2").value;
                var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                var duckEmailRegex = /^[^\s@]+@duck\.com$/;

                if (!emailRegex.test(textbox1Value)) {
                    alert("Please enter a valid email address");
                    return false;
                }
                if (!duckEmailRegex.test(textbox2Value)){
                    alert("Please enter a valid duck address");
                    return false;
                }
                var textbox1Parts = textbox1Value.split("@");
                var combinedText = textbox1Parts[0] + "_at_" + textbox1Parts[1] + "_" + textbox2Value;
                document.getElementById("combinedText").innerHTML = combinedText;
                document.getElementById("copyButton").removeAttribute("hidden");
                document.getElementById("mailButton").removeAttribute("hidden");
            }

            function copyToClipboard() {
                var combinedText = document.getElementById("combinedText");
                var range = document.createRange();
                range.selectNode(combinedText);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                document.execCommand("copy");
                window.getSelection().removeAllRanges();
                alert("Copied to clipboard!");
            }

            function sendEmail() {
                const combinedText = document.getElementById("combinedText").textContent;
                const mailtoLink = `mailto:${combinedText}`;
                window.location.href = mailtoLink;
            }

            function openPopup() {
                document.getElementById("popupInput").value = localStorage.getItem("apiKey");
                document.getElementById("popup").style.display = "block";
            }

            async function closePopup() {
                const apiKey = document.getElementById("popupInput").value;
                const emailAddresses = await postEmailAddresses(apiKey);
                console.log(emailAddresses);
                const duckAddress = emailAddresses.address + "@duck.com";
                document.getElementById("textbox2").value = duckAddress;
                localStorage.setItem("apiKey", apiKey);
                document.getElementById("popup").style.display = "none";
            }

            async function postEmailAddresses(apiKey) {
                const url = "https://quack.duckduckgo.com/api/email/addresses";
                const requestInit = {
                    method: "POST",
                    cache: "no-store",
                    redirect: "manual",
                    headers: {
                    Authorization: `Bearer ${apiKey}`,
                    "Content-Type": "application/json",
                    },
                };
                const corsAnywhereUrl = "https://cors-anywhere.herokuapp.com/" + url;
                const response = await fetch(corsAnywhereUrl, requestInit);
                if (response.status === 401) {
                    alert("Invalid DuckDuckGo API Key!");
                    return null;
                }
                const json = await response.json();
                return json;
            }
        </script>
        <footer>
            <button onclick="window.location.href='./help.html'" style="border-radius: 55px; background-color: #ff4d4d;">HELP!</button>
            <div style="margin-top: 10px;">
                <a href="https://github.com/Hamster45105/DuckAddressSend" target="_blank"><img src="https://img.shields.io/github/stars/Hamster45105/DuckAddressSend?style=social" alt="GitHub"></a>
            </div>
            <p>Made with ðŸ’– by <a href="https://github.com/Hamster45105">Hamster45105</a></p>
        </footer>
    </body>
</html>