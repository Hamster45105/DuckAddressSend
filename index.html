<!DOCTYPE html>
<html>
    <head>
        <title>Duck Address Send | Send emails FROM your duck addresses</title>
        <link rel="icon" href="favicon.ico" type="image/x-icon">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="./styles/style.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    </head>
    <body>
        <div class="container">
            <h1>Duck Address SendðŸ¦†</h1>
            <h2><i>Send emails from your duck addresses</i></h2>
            <h3>Did you know that you can send FROM duck addresses? Use this tool to help you do it!</h3>

            <div style="display: flex; flex-direction: column;">
                <label for="textbox1">Address/es to send TO (one per line):</label>
                <textarea id="textbox1" name="textbox1" placeholder="john@example.com" rows="1"></textarea>
                <label for="textbox2">Address to send FROM:</label>
                <div style="display: flex; flex-direction: row; align-items: center;">
                    <div style="display: flex; flex-direction: row; align-items: center; flex: 1; justify-content: flex-end;">
                        <input type="email" id="textbox2" name="textbox2" placeholder="tim@duck.com" style="flex-grow: 1;">
                        <button onclick="openPopup()" style="margin-left: auto; margin-top: -35px; padding: 5px 5px; height: 30px; background-color: transparent;">
                            <img src="generate_icon.png" alt="Generate address" style="height: 175%; width: auto;">
                        </button>
                    </div>
                                      
                    
                    <div id="popup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 999;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #fff; padding: 20px; border-radius: 5px; text-align: center;">
                            <h2>Generate Private Duck Address</Address></h2>
                            <p>Please enter your DuckDuckGo API key here. <a href='https://github.com/Hamster45105/DuckAddressSend/wiki/Get-DDG-API-Key'> Click here to find out how to get it.</a></p>
                            <input type="password" id="popupInput" style="width: 90%; padding: 10px;">
                            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                                <button onclick="closePopup()" style="background-color: #008CBA; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Generate</button>
                                <button onclick="document.getElementById('popup').style.display = 'none';" style="background-color: #f44336; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <div id="errorPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 999;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #fff; padding: 20px; border-radius: 5px; text-align: center; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5); animation: fade-in 0.5s ease-out;">
                            <h2 style="color: #ff0000;">Error</h2>
                            <p id="error-message" style="color: #ff0000;">An error occured</p>
                            <button onclick="closeErrorPopup();" style="background-color: #ff0000; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Dismiss</button>
                        </div>
                    </div>

                    <div id="starPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 999;">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #fff; padding: 20px; border-radius: 5px; text-align: center; box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5); animation: fade-in 0.5s ease-out;">
                            <h2 style="color: #000; font-size: 2em;">Give the project a ðŸŒŸ</h2>
                            <p style="color: #000; font-size: 1.2em;">If you like this project, please consider giving it a star on GitHub. This will help to support the development of the project!</p>
                            <button onclick="window.open('https://github.com/Hamster45105/DuckAddressSend', '_blank'); document.getElementById('starPopup').style.display = 'none';" style="background-color: #008CBA; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Give it a star! ðŸ¤©</button>
                        </div>
                        <button onclick="document.getElementById('starPopup').style.display = 'none';" style="position: absolute; top: 10px; right: 10px; background-color: #fff; color: #000; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">Close</button>
                    </div>
                    <style>
                        @keyframes fade-in {
                            from {
                                opacity: 0;
                            }
                            to {
                                opacity: 1;
                            }
                        }
                    </style>
                    

                    </div>     
                    <p id="loginLink" hidden style="color: #0074cc; text-decoration: underline; cursor: pointer;"><a href=""> Click here for your special login URL</a></p>
                    <button onclick="combineText()">Create Address!</button>
                

            <div style="display: flex; flex-direction: column; align-items: center;" hidden>
                <p id="combinedText" style="font-size: 24px; font-weight: bold; color: #333; margin-top: 20px; text-align: center;"></p>
                
            </div>
            <div style="display: flex; justify-content: center;">
                <button id="copyButton" onclick="copyToClipboard()" style="margin-top: 20px; background-color: #007bff; color: #fff; border: none; border-radius: 5px; padding: 10px 20px; cursor: pointer; text-align: center;" hidden>Copy to Clipboard</button>
                <button id="mailButton" onclick="sendEmail()" style="margin-top: 20px; margin-left: 10px; background-color: #007bff; color: #fff; border: none; border-radius: 5px; padding: 10px 20px; cursor: pointer; text-align: center;" hidden>Open in Mail</button>
            </div>
        </div>
        <script>
            let result;
            let errorTextbox;
            
            function combineText() {
                var textbox1Value = document.getElementById("textbox1").value;
                var textbox2Value = document.getElementById("textbox2").value;
                var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                var duckEmailRegex = /^[^\s@]+@duck\.com$/;

                const textareaElement = document.getElementById("textbox1");
                var lines = textareaElement.value.split("\n");

                const nonEmptyLines = lines.filter(line => line.trim() !== "");
                const newValue = nonEmptyLines.join("\n");
                textareaElement.value = newValue;
                var lines = textareaElement.value.split("\n");


                var results = [];

                    for (let i = 0; i < lines.length; i++) {
                        if (!emailRegex.test(lines[i])) {
                            openErrorPopup(`"${lines[i]}" (on line ${i + 1}) is not a valid email address`);
                            errorTextbox = "textbox1";
                            return false;
                        }
                        var textbox1Parts = lines[i].split("@");
                        var combinedText = textbox1Parts[0] + "_at_" + textbox1Parts[1] + "_" + textbox2Value;
                        results.push(combinedText);
                    }

                    if (!duckEmailRegex.test(textbox2Value)) {
                        openErrorPopup("Please enter a valid duck address!");
                        errorTextbox = "textbox2";
                        return false;
                    }

                    result = results.join(",");
                
                
                copyButton.style.backgroundColor = "#007bff";
                copyButton.textContent = "Copy to Clipboard";

                if (lines.length === 1) {
                    document.getElementById("combinedText").innerHTML = result;
                } else {
                    var resultLines = result.split(",");
                    var resultNewText = resultLines.join("\n");
                    document.getElementById("combinedText").innerHTML = resultNewText;
                }

                if (!duckEmailRegex.test(textbox2Value)){
                    openErrorPopup("Please enter a valid duck address!");
                    return false;
                }
                var textbox1Parts = textbox1Value.split("@");
                var combinedText = textbox1Parts[0] + "_at_" + textbox1Parts[1] + "_" + textbox2Value;
                copyButton.style.backgroundColor = "#007bff";
                copyButton.textContent = "Copy to Clipboard";
                document.getElementById("combinedText").innerHTML = combinedText;
                document.getElementById("copyButton").removeAttribute("hidden");
                document.getElementById("mailButton").removeAttribute("hidden");
                document.getElementById("loginLink").setAttribute("hidden", true);
            }

            function copyToClipboard() {
                const tempElement = document.createElement("textarea");
                tempElement.value = result;
                document.body.appendChild(tempElement);
                tempElement.select();
                document.execCommand("copy");
                document.body.removeChild(tempElement);
                copyButton.style.backgroundColor = "#6fc134";
                copyButton.textContent = "Copied!";
            }

            function sendEmail() {
                const mailtoLink = `mailto:${result}`;
                window.location.href = mailtoLink;
            }

            function openPopup() {
                document.getElementById("popupInput").value = localStorage.getItem("apiKey"); 
                document.getElementById("popup").style.display = "block";
                popupInput.focus();
            }

            function openErrorPopup(errorMessage) {
                document.getElementById("combinedText").innerHTML = "";
                document.getElementById("textbox2").blur();
                document.getElementById("copyButton").setAttribute("hidden", true);
                document.getElementById("mailButton").setAttribute("hidden", true);
                document.getElementById("error-message").innerHTML = errorMessage;
                document.getElementById("errorPopup").style.display = "block";
            }
            
            async function closePopup() {
                var emailAddresses;
                var duckAddress;
                const cookieValue = localStorage.getItem("loginAddress");
                const generatedKey = localStorage.getItem("loginAddressKey");
                const apiKey = document.getElementById("popupInput").value;
                if (cookieValue !== null && generatedKey == apiKey) {
                    emailAddresses = cookieValue;
                    localStorage.removeItem("loginAddress");
                    duckAddress = emailAddresses + "@duck.com";
                } else {
                    emailAddresses = await postEmailAddresses(apiKey);
                    duckAddress = emailAddresses.address + "@duck.com";
                }
                document.getElementById("textbox2").value = duckAddress;
                localStorage.setItem("apiKey", apiKey);
                document.getElementById("popup").style.display = "none";
                
                var loginLink = document.getElementById("loginLink");
                loginLink.innerHTML = `<a href="./auth_helper.html?key=${apiKey}"> Click here for your special login URL</a>`;
                loginLink.removeAttribute("hidden");

            }
            async function postEmailAddresses(apiKey) {
                const url = "https://corsproxy.io/?https://quack.duckduckgo.com/api/email/addresses";
                const requestInit = {
                    method: "POST",
                    headers: {
                    Authorization: `Bearer ${apiKey}`,
                    "Content-Type": "application/json",
                    "x-cors-api-key": 'KEY_HERE'
                    },
                };
                const response = await fetch(url, requestInit);
                if (response.status === 401) {
                    openErrorPopup("Invalid DuckDuckGo API Key!");
                    return null;
                }
                const json = await response.json();
                return json;
            } 
            function showStarPopup() {
            if (!localStorage.getItem("popupShown")) {
                document.getElementById("starPopup").style.display = "block";
                localStorage.setItem("popupShown", true);
            }
            }
            function pageLoad() {
                showStarPopup();
                document.getElementById("textbox1").value = "";
                document.getElementById("textbox2").value = "";

                const urlParams = new URLSearchParams(window.location.search);
                const resizeValue = urlParams.get('resize');
                if (resizeValue === 'true') {
                    textbox1.style.resize = 'vertical';
                }
            }
            function closeErrorPopup() {
                document.getElementById("errorPopup").style.display = "none";
                document.getElementById(errorTextbox).focus();
                decreaseTextAreaSize();
            }
            function increaseTextAreaSize() {
                document.getElementById("textbox1").rows += 1;
            }
            function decreaseTextAreaSize() {
                var numRows = document.getElementById("textbox1").rows;
                var newNumLines = document.getElementById("textbox1").value.split("\n").length;
                if (newNumLines < numRows) {
                    textbox1.rows = newNumLines;
                }
            }

        window.addEventListener("load", pageLoad);

        // Keyboard shortcuts
        document.addEventListener("keydown", function(event) {
        if (event.ctrlKey && event.keyCode === 13) {
            document.getElementById("textbox2").focus();
        }
        });
        
        document.addEventListener("keydown", function(event) {
            if (event.keyCode === 13 && !event.ctrlKey && !event.altKey && !event.shiftKey) {
                if (errorPopup.style.display === "block") {
                    event.preventDefault();
                    errorPopup.style.display = "none";
                        setTimeout(function() {
                            closeErrorPopup();
                        }, 0);
                    
                }
                if (popup.style.display === "block") {
                    event.preventDefault();
                    popup.style.display = "none";
                }
                if (document.activeElement === document.getElementById("textbox2")) {
                    combineText();
                }
                if (document.activeElement === document.getElementById("textbox1")) {
                    document.getElementById("textbox1").rows += 1;
                }
            }
        });

        textbox1.addEventListener("input", function() {
            decreaseTextAreaSize();
        });
        </script>
        </div>
    
    <footer>
    <button onclick="window.location.href='https://github.com/Hamster45105/DuckAddressSend/wiki'" style="border-radius: 55px; background-color: #ff4d4d;">HELP!</button>
    <div style="margin-top: 10px;">
        <a href="https://github.com/Hamster45105/DuckAddressSend" target="_blank"><img src="https://img.shields.io/github/stars/Hamster45105/DuckAddressSend?style=social" alt="GitHub"></a>
    </div>
    <p>Made with ðŸ’– by <a href="https://github.com/Hamster45105">Hamster45105</a></p>
    <p>Disclaimer: This website is not made by or an official service of DuckDuckGo in any way!</p>
    <p style="font-size: 1.2em; font-weight: bold;"> <a href="https://github.com/Hamster45105/DuckAddressSend/releases/latest">Version 1.6.1</a></p>
    </footer>
            </body>
        </html>
    </body>
</html>